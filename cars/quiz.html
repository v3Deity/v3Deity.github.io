<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <link rel="icon" href="favicon.png" type="image/x-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libertinus+Mono&display=swap" rel="stylesheet">

  <title>Car Quiz</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<header class="navbar">
  <a href="https://3deity.space" class="navbar-icon">
    <img src="navbar-icon.png" alt="Home">
  </a>
  <nav class="navbar-links">
    <a href="https://3deity.space">Home</a> |
    <a href="about">About Me</a> |
    <a href="links">My Links</a> |
    <a href="stats">Statistics</a> |
    <a href="blog">My Blog</a>
  </nav>
</header>

<div class="content-box">
  <h1>Deity's Random Car Quiz</h1>
  <hr>

  <div id="car-header" style="display:flex; align-items:center; gap:20px; justify-content:center;">
    <img id="car-image"
      src="placeholder.png"
      onerror="this.src='placeholder.png';"
      style="width:200px; border:2px solid black; border-radius:6px;">
    <h2 id="car-name"></h2>
  </div>

  <br>

  <table id="quiz-table" style="width:100%; border-collapse:collapse; text-align:center;">
    <thead>
      <tr>
        <th>Property</th>
        <th>Value</th>
        <th>Your Answer</th>
        <th>Check</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <hr>

  <div class="button-container" style="text-align:center;">
    <button id="revealAllButton">Reveal All</button>
    <button id="randomCarButton">New Car Model</button>
    <button id="openInTabButton">➹ Wikipedia</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

const INFOBOX_BLACKLIST = [
  "image",
  "caption",
  "name",
  "sp",
  "logo",
  "flag"
];

/* ================= STATE ================= */

let cachedCars = null;
let currentCarTitle = "";
let currentRows = [];

/* ================= UTILS ================= */

function titleCase(str) {
  return str.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
}

function cleanWikitext(text) {
  return text
    .replace(/<ref.*?>.*?<\/ref>/g, "")
    .replace(/\[\[([^|\]]+\|)?([^\]]+)\]\]/g, "$2")
    .replace(/'''?/g, "")
    .trim();
}

/* === {{convert}} handling === */
function parseConvertTemplates(text) {
  return text.replace(/\{\{convert\|([^}]+)\}\}/g, (_, args) => {
    const p = args.split("|");
    const v = parseFloat(p[0]);
    const from = p[1];
    const to = p[2];
    const d = parseInt(p[3] || 0);

    const map = {
      in: { mm: x => x * 25.4 },
      lb: { kg: x => x * 0.453592 },
      bhp: { kW: x => x * 0.7457 }
    };

    if (!map[from] || !map[from][to]) return p[0];

    return `${v.toLocaleString()} ${from} (${map[from][to](v).toLocaleString(undefined,{maximumFractionDigits:d})} ${to})`;
  });
}

/* ================= DATA ================= */

async function loadCarList() {
  if (!cachedCars) {
    const res = await fetch("/data/car_models.json");
    cachedCars = await res.json();
  }
}

function pickRandomTitle() {
  return cachedCars[Math.floor(Math.random() * cachedCars.length)].replace(/ /g, "_");
}

async function fetchCarImage(title) {
  const res = await fetch(
    `https://en.wikipedia.org/w/api.php?origin=*&action=query&titles=${encodeURIComponent(title)}&prop=pageimages&pithumbsize=400&format=json`
  );
  const data = await res.json();
  const page = data.query.pages[Object.keys(data.query.pages)[0]];
  return page.thumbnail?.source || "placeholder.png";
}

async function fetchCarData(title) {
  const res = await fetch(
    `https://en.wikipedia.org/w/api.php?origin=*&action=parse&page=${encodeURIComponent(title)}&prop=wikitext&format=json`
  );
  const data = await res.json();
  const wikitext = data.parse.wikitext["*"];

  const box = wikitext.match(/\{\{Infobox automobile([\s\S]*?)\n\}\}/);
  if (!box) return null;

  const rows = box[1].split("\n").filter(l => l.startsWith("|"));

  const properties = rows.map(l => {
    const [k, ...r] = l.slice(1).split("=");
    const key = k.trim().toLowerCase();
    const raw = r.join("=").trim();
    if (!raw || INFOBOX_BLACKLIST.includes(key)) return null;

    const processed = cleanWikitext(parseConvertTemplates(raw));
    const answers = processed.split(/\n|\*\s*/).map(v => v.trim()).filter(Boolean);

    return {
      label: titleCase(key),
      answers,
      userInput: "",
      revealed: false
    };
  }).filter(Boolean);

  return {
    title: title.replace(/_/g, " "),
    image: await fetchCarImage(title),
    properties
  };
}

/* ================= RENDER ================= */

function renderCar(car) {
  carName.textContent = car.title;
  carImage.src = car.image;
  currentRows = car.properties;
  renderTable();
}

function renderTable() {
  const tbody = document.querySelector("#quiz-table tbody");
  tbody.innerHTML = "";

  currentRows.forEach((r, i) => {
    const tr = document.createElement("tr");

    tr.innerHTML = r.revealed
      ? `<td>${r.label}</td>
         <td>${r.answers.join("<br>")}</td>
         <td>${r.userInput}</td>
         <td>${bestScore(r.userInput, r.answers)}%</td>`
      : `<td>${r.label}</td>
         <td style="background:black;color:black;">████</td>
         <td><input style="text-align:center" data-i="${i}"></td>
         <td><button data-i="${i}">Check?</button></td>`;

    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button").forEach(b => {
    b.onclick = () => {
      const i = b.dataset.i;
      const input = tbody.querySelector(`input[data-i="${i}"]`);
      currentRows[i].userInput = input.value;
      currentRows[i].revealed = true;
      renderTable();
    };
  });
}

/* ================= FUZZY SCORING ================= */

function levenshtein(a, b) {
  const m = [];
  for (let i = 0; i <= b.length; i++) m[i] = [i];
  for (let j = 0; j <= a.length; j++) m[0][j] = j;

  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      m[i][j] = b[i - 1] === a[j - 1]
        ? m[i - 1][j - 1]
        : Math.min(m[i - 1][j - 1] + 1, m[i][j - 1] + 1, m[i - 1][j] + 1);
    }
  }
  return m[b.length][a.length];
}

function similarity(a, b) {
  const dist = levenshtein(a, b);
  return Math.max(0, 1 - dist / Math.max(a.length, b.length));
}

function bestScore(user, answers) {
  if (!user) return 0;
  user = user.toLowerCase();
  return Math.max(...answers.map(a =>
    Math.round(similarity(user, a.toLowerCase()) * 100)
  ));
}

/* ================= ACTIONS ================= */

function revealAll() {
  currentRows.forEach(r => r.revealed = true);
  renderTable();
}

async function loadNewCar() {
  currentCarTitle = pickRandomTitle();
  renderCar(await fetchCarData(currentCarTitle));
}

/* ================= INIT ================= */

document.addEventListener("DOMContentLoaded", async () => {
  await loadCarList();
  await loadNewCar();

  revealAllButton.onclick = revealAll;
  randomCarButton.onclick = loadNewCar;
  openInTabButton.onclick = () =>
    window.open("https://en.wikipedia.org/wiki/" + currentCarTitle, "_blank");
});
</script>

</body>
</html>
