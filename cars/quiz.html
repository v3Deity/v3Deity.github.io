<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <link rel="icon" href="favicon.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libertinus+Mono&display=swap" rel="stylesheet">

  <title>Car Quiz</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<header class="navbar">
  <a href="https://3deity.space" class="navbar-icon">
    <img src="navbar-icon.png" alt="Home">
  </a>
  <nav class="navbar-links">
    <a href="https://3deity.space">Home</a> |
    <a href="about">About Me</a> |
    <a href="links">My Links</a> |
    <a href="stats">Statistics</a> |
    <a href="blog">My Blog</a>
  </nav>
</header>

<div class="content-box">
  <h1>Deity's Random Car Quiz</h1>
  <hr>

  <div class="button-container">
    <a href="https://3deity.space/cars/quizmaker">
      <button>Make a Quiz</button>
    </a>
    <button id="uploadQuizButton">Load Custom Quiz</button>
    <button id="pasteQuizButton">Paste Quiz JSON</button>
    <input type="file" id="quizFileInput" accept=".json" hidden>
  </div>

  <hr>

  <div id="car-header" style="display:flex; align-items:center; gap:20px;">
    <img id="car-image"
      src="placeholder.png"
      onerror="this.src='placeholder.png';"
      style="width:200px; border:2px solid black; border-radius:6px;">
    <h2 id="car-name"></h2>
  </div>

  <br>

  <table id="quiz-table" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th>Property</th>
        <th>Value</th>
        <th>Your Answer</th>
        <th>Check</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <hr>

  <div class="button-container">
    <button id="checkAllButton">Check All</button>
    <button id="randomCarButton">New Car Model</button>
    <button id="openInTabButton">➹ Wikipedia</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

const INFOBOX_BLACKLIST = ["image","caption","name","sp","logo","flag"];

/* ================= STATE ================= */

let defaultCars = null;
let customCars = null;
let currentCarTitle = "";
let currentRows = [];

/* ================= CAR LIST ================= */

function getActiveCarList() {
  return customCars?.length ? customCars : defaultCars;
}

async function loadDefaultCarList() {
  if (!defaultCars) {
    const res = await fetch("/data/car_models.json");
    defaultCars = await res.json();
  }
}

function pickRandomTitle() {
  const list = getActiveCarList();
  return list[Math.floor(Math.random() * list.length)].replace(/ /g, "_");
}

/* ================= CUSTOM QUIZ LOAD ================= */

function normalizeCarJSON(data) {
  if (Array.isArray(data)) return data;
  if (Array.isArray(data.cars)) return data.cars;
  throw new Error("Invalid quiz format");
}

function applyCustomQuiz(list) {
  customCars = list;
  loadNewCar();
}

document.getElementById("uploadQuizButton").onclick = () =>
  document.getElementById("quizFileInput").click();

document.getElementById("quizFileInput").onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const json = JSON.parse(text);
    applyCustomQuiz(normalizeCarJSON(json));
    alert("Custom quiz loaded!");
  } catch {
    alert("Invalid JSON file.");
  }
};

document.getElementById("pasteQuizButton").onclick = () => {
  const input = prompt("Paste your quiz JSON:");
  if (!input) return;

  try {
    const json = JSON.parse(input);
    applyCustomQuiz(normalizeCarJSON(json));
    alert("Custom quiz loaded!");
  } catch {
    alert("Invalid JSON.");
  }
};

/* ================= FETCH & RENDER (UNCHANGED CORE) ================= */

// (Everything below this point is unchanged logic-wise)

function cleanWikitext(text) {
  return text
    .replace(/<ref.*?>.*?<\/ref>/g, "")
    .replace(/\[\[([^|\]]+\|)?([^\]]+)\]\]/g, "$2")
    .replace(/'''?/g, "")
    .trim();
}

function parseConvertTemplates(text) {
  return text.replace(/\{\{convert\|([^}]+)\}\}/g, (_, args) => {
    const [v,f,t,d=0] = args.split("|");
    const conv = { in:{mm:25.4}, lb:{kg:0.453592}, bhp:{kW:0.7457} };
    if (!conv[f]?.[t]) return v;
    return `${(+v).toLocaleString()} ${f} (${(+v*conv[f][t]).toLocaleString(undefined,{maximumFractionDigits:d})} ${t})`;
  });
}

async function fetchCarImage(title) {
  const r = await fetch(`https://en.wikipedia.org/w/api.php?origin=*&action=query&titles=${title}&prop=pageimages&pithumbsize=400&format=json`);
  const d = await r.json();
  const p = d.query.pages[Object.keys(d.query.pages)[0]];
  return p.thumbnail?.source || "placeholder.png";
}

async function fetchCarData(title) {
  const r = await fetch(`https://en.wikipedia.org/w/api.php?origin=*&action=parse&page=${title}&prop=wikitext&format=json`);
  const d = await r.json();
  const w = d.parse.wikitext["*"];
  const box = w.match(/\{\{Infobox automobile([\s\S]*?)\n\}\}/);
  if (!box) return null;

  const props = box[1].split("\n").filter(l=>l.startsWith("|")).map(l=>{
    const [k,...r]=l.slice(1).split("=");
    const key=k.trim().toLowerCase();
    if (INFOBOX_BLACKLIST.includes(key)) return null;
    const val=cleanWikitext(parseConvertTemplates(r.join("=").trim()));
    if (!val) return null;
    return { label:key.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()), answers:val.split(/\n|\*/).filter(Boolean), revealed:false, userInput:"" };
  }).filter(Boolean);

  return { title:title.replace(/_/g," "), image:await fetchCarImage(title), properties:props };
}

function renderCar(car) {
  car && (
    document.getElementById("car-name").textContent = car.title,
    document.getElementById("car-image").src = car.image,
    currentRows = car.properties,
    renderTable()
  );
}

function renderTable() {
  const t=document.querySelector("#quiz-table tbody");
  t.innerHTML="";
  currentRows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = r.revealed
      ? `<td>${r.label}</td><td>${r.answers.join("<br>")}</td><td>${r.userInput}</td><td>${bestScore(r.userInput,r.answers)}%</td>`
      : `<td>${r.label}</td><td style="background:black;color:black;">████</td><td><input data-i="${i}"></td><td><button data-i="${i}">Check?</button></td>`;
    t.appendChild(tr);
  });
  t.querySelectorAll("button").forEach(b=>b.onclick=()=>{
    const i=b.dataset.i;
    currentRows[i].userInput=t.querySelector(`input[data-i="${i}"]`).value;
    currentRows[i].revealed=true;
    renderTable();
  });
}

function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++)m[i]=[i];for(let j=0;j<=a.length;j++)m[0][j]=j;for(let i=1;i<=b.length;i++)for(let j=1;j<=a.length;j++)m[i][j]=b[i-1]===a[j-1]?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);return m[b.length][a.length]}
function similarity(a,b){return Math.max(0,1-levenshtein(a,b)/Math.max(a.length,b.length))}
function bestScore(u,a){return u?Math.max(...a.map(v=>Math.round(similarity(u.toLowerCase(),v.toLowerCase())*100))):0}

function checkAllRows(){document.querySelectorAll("input").forEach(i=>{const x=i.dataset.i;currentRows[x].userInput=i.value;currentRows[x].revealed=true});renderTable()}
checkAllButton.onclick = checkAllRows;

async function loadNewCar() {
  currentCarTitle = pickRandomTitle();
  renderCar(await fetchCarData(currentCarTitle));
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadDefaultCarList();
  loadNewCar();
  randomCarButton.onclick = loadNewCar;
  openInTabButton.onclick = () => window.open("https://en.wikipedia.org/wiki/"+currentCarTitle);
});
</script>

</body>
</html>
